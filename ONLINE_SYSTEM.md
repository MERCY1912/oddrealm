# Система отслеживания онлайн игроков

## Обзор
Реализована полноценная система отслеживания онлайн игроков с реальным временем обновления и детальными статусами.

## Компоненты

### 1. OnlineService (`src/services/onlineService.ts`)
Основной сервис для работы с онлайн игроками:
- `updateUserPresence()` - обновление присутствия пользователя
- `getOnlinePlayers()` - получение списка онлайн игроков
- `getPlayerStats()` - получение статистики по статусам
- `setPlayerStatus()` - установка статуса игрока

### 2. Хуки
- `useOnlinePlayers()` - хук для работы со списком игроков
- `useUserPresence()` - хук для отслеживания собственного присутствия

### 3. Компоненты
- `OnlinePlayersList` - обновленный компонент списка игроков
- Интеграция в `GameInterface` для автоматического обновления статуса

## Статусы игроков
- `online` - активен в игре
- `afk` - отсутствует (неактивен более 5 минут)
- `in_battle` - в бою
- `in_dungeon` - в подземелье

## База данных

### Миграция `20250119000000_enhance_online_system.sql`
- Добавлен enum `player_status`
- Расширена таблица `user_activity`
- Созданы функции для работы с онлайн игроками
- Добавлены индексы для оптимизации

### Функции БД
- `update_user_presence()` - обновление присутствия
- `get_online_players()` - получение списка игроков
- `get_online_stats()` - получение статистики

## Особенности

### Автоматическое обновление
- Присутствие обновляется каждые 30 секунд
- Отслеживание активности пользователя (клики, движение мыши, клавиатура)
- Обновление при фокусе окна

### Статусы в зависимости от действий
- Переход в арену → статус "в бою"
- Переход в подземелье → статус "в подземелье"
- Возврат в город → статус "онлайн"

### UI улучшения
- Заголовок с кнопкой обновления
- Цветовая индикация статусов
- Отображение локации игроков
- Статистика в заголовке (онлайн/AFK/в бою/в подземельях)

## Использование

### В компонентах
```typescript
import { useOnlinePlayers } from '@/hooks/useOnlinePlayers';
import { useUserPresence } from '@/hooks/useUserPresence';

// Получение списка игроков
const { onlinePlayers, onlineCount, afkCount, totalCount } = useOnlinePlayers();

// Отслеживание присутствия
const { setStatus } = useUserPresence();
setStatus('in_battle'); // при входе в бой
```

### В сервисах
```typescript
import OnlineService from '@/services/onlineService';

const onlineService = OnlineService.getInstance();
await onlineService.updateUserPresence('online', 'Таврос');
```

## Производительность
- Оптимизированные запросы к БД
- Кэширование результатов
- Автоматическая очистка неактивных игроков (10+ минут)
- Индексы для быстрого поиска

## Безопасность
- RLS политики для защиты данных
- Проверка авторизации
- Валидация входных данных

