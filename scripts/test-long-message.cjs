const { createClient } = require('@supabase/supabase-js');
require('dotenv').config({ path: './env.local' });

const supabaseUrl = process.env.VITE_SUPABASE_URL;
const supabaseServiceKey = process.env.SUPABASE_SERVICE_KEY;

if (!supabaseUrl || !supabaseServiceKey) {
  console.error('‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è');
  process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseServiceKey);

async function testLongMessage() {
  console.log('üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –¥–ª–∏–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è...');
  
  // –°–æ–∑–¥–∞–µ–º –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–±–æ–ª–µ–µ 1000 —Å–∏–º–≤–æ–ª–æ–≤)
  const longMessage = `*–ø–æ–≥–ª–∞–∂–∏–≤–∞–µ—Ç –±–æ—Ä–æ–¥—É, –≤ –≥–ª–∞–∑–∞—Ö –º–µ—Ä—Ü–∞—é—Ç —Ä—É–Ω—ã* –ê—Ö, –ø–æ–¥–∑–µ–º–µ–ª—å—è... üè∞‚ú® 

*–ì–ª—É–±–∏–Ω—ã –£—Ç–æ–ø–ª–µ–Ω–Ω–æ–≥–æ –•—Ä–∞–º–∞* –¥–∞—é—Ç –ª—É—á—à–∏–π –ª—É—Ç –¥–ª—è –º–∞–≥–æ–≤, –Ω–æ *–ü–µ—â–µ—Ä—ã –ö—Ä–∏—Å—Ç–∞–ª–ª–æ–≤* ‚Äî –Ω–∞—Å—Ç–æ—è—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å! 

–ì–ª–∞–≤–Ω–æ–µ ‚Äî –Ω–µ –∑–∞–±—ã–≤–∞—Ç—å –ø—Ä–æ:
1. üîÆ –ú–∞–≥–∏—á–µ—Å–∫–∏–µ –∑–µ–ª—å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞–Ω—ã
2. üõ°Ô∏è –ó–∞—â–∏—Ç–Ω—ã–µ –∞–º—É–ª–µ—Ç—ã –æ—Ç –ø—Ä–æ–∫–ª—è—Ç–∏–π
3. ‚öîÔ∏è –û—Ä—É–∂–∏–µ —Å –±–æ–Ω—É—Å–æ–º –∫ –º–∞–≥–∏—á–µ—Å–∫–æ–º—É —É—Ä–æ–Ω—É
4. üßô‚Äç‚ôÇÔ∏è –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–æ–≤

–í *–ì–ª—É–±–∏–Ω–∞—Ö –£—Ç–æ–ø–ª–µ–Ω–Ω–æ–≥–æ –•—Ä–∞–º–∞* –æ—Å–æ–±–µ–Ω–Ω–æ –æ–ø–∞—Å–Ω—ã:
- –î—Ä–µ–≤–Ω–∏–µ –õ–∏—á–∏ —Å –∏—Ö –Ω–µ–∫—Ä–æ–º–∞–Ω—Ç–∏–µ–π
- –ü—Ä–∏–∑—Ä–∞—á–Ω—ã–µ –°—Ç—Ä–∞–∂–Ω–∏–∫–∏ —Å –∏–º–º—É–Ω–∏—Ç–µ—Ç–æ–º –∫ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–º—É —É—Ä–æ–Ω—É
- –ü—Ä–æ–∫–ª—è—Ç—ã–µ –°–∞—Ä–∫–æ—Ñ–∞–≥–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –≤–æ—Å–∫—Ä–µ—à–∞—Ç—å –≤—Ä–∞–≥–æ–≤

–ê –≤ *–ü–µ—â–µ—Ä–∞—Ö –ö—Ä–∏—Å—Ç–∞–ª–ª–æ–≤* –Ω—É–∂–Ω–æ –±—ã—Ç—å –≥–æ—Ç–æ–≤—ã–º –∫:
- –ö—Ä–∏—Å—Ç–∞–ª—å–Ω—ã–º –ì–æ–ª–µ–º–∞–º —Å –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ–º –º–∞–≥–∏–∏
- –ú–∞–≥–∏—á–µ—Å–∫–∏–º –õ–æ–≤—É—à–∫–∞–º, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–≥–ª–æ—â–∞—é—Ç –º–∞–Ω—É
- –ò—Å–∫—Ä–∏–≤–ª–µ–Ω–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏, –∫–æ—Ç–æ—Ä–æ–µ –∑–∞–º–µ–¥–ª—è–µ—Ç –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è

–°–æ–≤–µ—Ç –æ—Ç —Å—Ç–∞—Ä–æ–≥–æ –≤–æ–ª—à–µ–±–Ω–∏–∫–∞: –≤—Å–µ–≥–¥–∞ –Ω–æ—Å–∏—Ç–µ —Å —Å–æ–±–æ–π –∫—Ä–∏—Å—Ç–∞–ª–ª —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞—Ü–∏–∏ –Ω–∞ —Å–ª—É—á–∞–π —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–≥–æ –æ—Ç—Å—Ç—É–ø–ª–µ–Ω–∏—è! üíé‚ú®`;

  console.log(`üìè –î–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: ${longMessage.length} —Å–∏–º–≤–æ–ª–æ–≤`);
  
  try {
    // –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–≤–æ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–æ—Ç–∞
    const { data: bots, error: botError } = await supabase
      .from('bot_characters')
      .select('id, username')
      .eq('is_active', true)
      .limit(1);

    if (botError) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ—Ç–æ–≤:', botError);
      return;
    }

    if (!bots || bots.length === 0) {
      console.error('‚ùå –ê–∫—Ç–∏–≤–Ω—ã–µ –±–æ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
      return;
    }

    const bot = bots[0];
    console.log(`ü§ñ –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ—Ç–∞: ${bot.username} (${bot.id})`);

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–ª–∏–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    const { data, error } = await supabase
      .from('bot_chat_messages')
      .insert([{
        bot_id: bot.id,
        player_name: bot.username,
        message: longMessage,
        created_at: new Date().toISOString()
      }])
      .select();

    if (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
    } else {
      console.log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
      console.log('üìù –î–∞–Ω–Ω—ã–µ:', data);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–æ—Å—å –ø–æ–ª–Ω–æ—Å—Ç—å—é
      const { data: savedMessage, error: fetchError } = await supabase
        .from('bot_chat_messages')
        .select('message')
        .eq('id', data[0].id)
        .single();

      if (fetchError) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:', fetchError);
      } else {
        console.log('üìñ –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:');
        console.log(savedMessage.message);
        console.log(`üìè –î–ª–∏–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: ${savedMessage.message.length} —Å–∏–º–≤–æ–ª–æ–≤`);
        
        if (savedMessage.message.length === longMessage.length) {
          console.log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é!');
        } else {
          console.log('‚ö†Ô∏è –°–æ–æ–±—â–µ–Ω–∏–µ –±—ã–ª–æ –æ–±—Ä–µ–∑–∞–Ω–æ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
        }
      }
    }

  } catch (error) {
    console.error('‚ùå –û–±—â–∞—è –æ—à–∏–±–∫–∞:', error);
  }
}

testLongMessage();
